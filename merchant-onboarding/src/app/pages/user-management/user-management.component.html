<app-navbar></app-navbar>

<div class="container">
  <div class="breadcrumb">
    <a routerLink="/account-management">Account Management</a>
    <span class="breadcrumb-separator">&gt;</span>
    <span class="breadcrumb-current">User Management</span>
  </div>

  <div class="page-header">
    <h1>User Management</h1>
    <button class="btn-primary" (click)="showCreateUserModal()">Add New</button>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filters">
    <div class="filter-controls">
      <input type="text" [(ngModel)]="searchTerm" placeholder="Name">
      <select [(ngModel)]="roleFilter">
        <option value="">All Roles</option>
        <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
      </select>
      <select [(ngModel)]="statusFilter">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select [(ngModel)]="departmentFilter">
        <option value="">All Departments</option>
        <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
      </select>
      <button class="btn-primary" (click)="applyFilters()">Search</button>
      <button class="btn-secondary" (click)="clearFilters()">Clear</button>
    </div>
  </div>

  <div class="users-table">
    <table>
      <thead>
        <tr>
          <th>User ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Department</th>
          <th>Status</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.id }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ getRoleName(user.roleId) }}</td>
          <td>{{ user.department }}</td>
          <td><span [class]="'status-' + user.status">{{ user.status | titlecase }}</span></td>
          <td>{{ user.lastLogin }}</td>
          <td>
            <button class="btn-small" (click)="openViewUser(user.id)">View</button>
            <button class="btn-small" (click)="editUser(user.id)">Edit</button>
            <button class="btn-small btn-danger" (click)="deleteUser(user.id)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="filteredUsers.length === 0">
          <td colspan="8" style="text-align: center; padding: 20px;">No users found</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal" *ngIf="showUserModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ modalTitle }}</h3>
      <span class="close" (click)="closeUserModal()">&times;</span>
    </div>

    <!-- Modal Tabs (only for edit + admin) -->
    <div class="modal-tabs" *ngIf="currentEditingId && isAdmin" style="display: flex;">
      <button class="tab-btn" [class.active]="activeTab === 'details'" (click)="activeTab = 'details'">User Details</button>
      <button class="tab-btn" [class.active]="activeTab === 'permissions'" (click)="activeTab = 'permissions'">Permissions</button>
    </div>

    <div class="modal-body">
      <!-- User Details Tab -->
      <div *ngIf="activeTab === 'details'">
        <form>
           <div class="form-row">
            <div class="form-group">
              <label>Full Name:</label>
              <input type="text" [(ngModel)]="userName" name="userName" required
                     (focus)="nameTouched = true"
                     (ngModelChange)="validateName()"
                     [class.input-error]="nameError">
              <small class="error-text" *ngIf="nameError">{{ nameError }}</small>
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" [(ngModel)]="userEmail" name="userEmail" required
                     placeholder="username&#64;bank.com"
                     [pattern]="emailPattern"
                     title="Email must use &#64;bank.com domain"
                     (focus)="emailTouched = true"
                     (ngModelChange)="validateEmail()"
                     [class.input-error]="emailError">
              <small class="hint" *ngIf="!emailError">Only &#64;bank.com email addresses are allowed</small>
              <small class="error-text" *ngIf="emailError">{{ emailError }}</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Role:</label>
              <select [(ngModel)]="userRole" name="userRole" required
                      (focus)="roleTouched = true"
                      (ngModelChange)="validateRole()"
                      [class.input-error]="roleError">
                <option value="">Select Role</option>
                <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
              </select>
              <small class="error-text" *ngIf="roleError">{{ roleError }}</small>
            </div>
            <div class="form-group">
              <label>Department:</label>
              <select [(ngModel)]="userDepartment" name="userDepartment" required
                      (focus)="departmentTouched = true"
                      (ngModelChange)="validateDepartment()"
                      [class.input-error]="departmentError">
                <option value="">Select Department</option>
                <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
              </select>
              <small class="error-text" *ngIf="departmentError">{{ departmentError }}</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone Number:</label>
              <input type="tel" [(ngModel)]="userPhone" name="userPhone"
                     (focus)="phoneTouched = true"
                     (ngModelChange)="validatePhone()"
                     [class.input-error]="phoneError">
              <small class="error-text" *ngIf="phoneError">{{ phoneError }}</small>
            </div>
            <div class="form-group">
              <label>Status:</label>
              <select [(ngModel)]="userStatus" name="userStatus" required>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>
          <!-- Password fields - only shown when adding a new user -->
          <div class="form-row" *ngIf="!currentEditingId">
            <div class="form-group">
              <label>Password:</label>
              <div class="password-wrapper">
                <input [type]="showPassword ? 'text' : 'password'" [(ngModel)]="userPassword" name="userPassword" required
                       placeholder="Password"
                       (focus)="passwordTouched = true"
                       (ngModelChange)="validatePassword()"
                       [class.input-error]="passwordError">
                <span class="password-toggle" (click)="showPassword = !showPassword">
                  <svg *ngIf="!showPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  <svg *ngIf="showPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </span>
              </div>
              <small class="error-text" *ngIf="passwordError">{{ passwordError }}</small>
            </div>
            <div class="form-group">
              <label>Re-enter Password:</label>
              <div class="password-wrapper">
                <input [type]="showConfirmPassword ? 'text' : 'password'" [(ngModel)]="userConfirmPassword" name="userConfirmPassword" required
                       placeholder="Re-enter Password"
                       (focus)="confirmPasswordTouched = true"
                       (ngModelChange)="validateConfirmPassword()"
                       [class.input-error]="confirmPasswordError">
                <span class="password-toggle" (click)="showConfirmPassword = !showConfirmPassword">
                  <svg *ngIf="!showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                  <svg *ngIf="showConfirmPassword" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                </span>
              </div>
              <small class="error-text" *ngIf="confirmPasswordError">{{ confirmPasswordError }}</small>
            </div>
          </div>
          <div class="form-group">
            <label>Notes (Optional):</label>
            <textarea [(ngModel)]="userNotes" name="userNotes" rows="3" placeholder="Additional notes about the user..."></textarea>
          </div>
        </form>
      </div>

      <!-- Permissions Tab -->
      <div *ngIf="activeTab === 'permissions'">
        <div class="permissions-assignment">
          <h4>Assign Custom Permissions</h4>
          <p class="permission-note">Note: These permissions will override the default role permissions.</p>
          <div class="permissions-search">
            <input type="text" [(ngModel)]="permissionSearch" placeholder="Search permissions...">
          </div>
          <div class="permissions-container">
            <label class="permission-checkbox" *ngFor="let perm of getFilteredPermissions()">
              <input type="checkbox" [(ngModel)]="customPermissions[perm.id]">
              <div class="permission-info">
                <span class="permission-name">{{ perm.name }}</span>
                <span class="permission-desc">{{ perm.description }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeUserModal()">Cancel</button>
      <button type="button" class="btn-primary" (click)="saveUser()" [disabled]="hasFormErrors">Save User</button>
    </div>
  </div>
</div>

<!-- View User Modal -->
<div class="modal" *ngIf="showViewModal">
  <div class="modal-content" *ngIf="viewUser">
    <div class="modal-header">
      <h3>User Details</h3>
      <span class="close" (click)="closeViewModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="user-view-section">
        <h4>Personal Information</h4>
        <div class="info-grid">
          <div class="info-item"><label>User ID:</label><span>{{ viewUser.id }}</span></div>
          <div class="info-item"><label>Full Name:</label><span>{{ viewUser.name }}</span></div>
          <div class="info-item"><label>Email:</label><span>{{ viewUser.email }}</span></div>
          <div class="info-item"><label>Phone:</label><span>{{ viewUser.phone || 'Not provided' }}</span></div>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Role &amp; Department</h4>
        <div class="info-grid">
          <div class="info-item"><label>Role:</label><span>{{ viewUserRole?.name || 'Unknown' }}</span></div>
          <div class="info-item"><label>Department:</label><span>{{ viewUser.department }}</span></div>
          <div class="info-item"><label>Status:</label><span [class]="'status-' + viewUser.status">{{ viewUser.status | titlecase }}</span></div>
          <div class="info-item"><label>Last Login:</label><span>{{ viewUser.lastLogin }}</span></div>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Role Permissions</h4>
        <div class="permissions-display">
          <div class="permission-item-view" *ngFor="let perm of getViewUserPermissions()">
            <span class="permission-name">{{ perm.name }}</span>
            <span class="permission-desc">{{ perm.description }}</span>
          </div>
          <p *ngIf="getViewUserPermissions().length === 0">No permissions assigned</p>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Additional Information</h4>
        <div class="info-item"><label>Notes:</label><p>{{ viewUser.notes || 'No notes available' }}</p></div>
        <div class="info-grid">
          <div class="info-item"><label>Created:</label><span>{{ viewUser.createdAt }}</span></div>
          <div class="info-item"><label>Last Updated:</label><span>{{ viewUser.updatedAt || 'Never' }}</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- User Permissions Modal -->
<div class="modal" *ngIf="showPermissionsModal">
  <div class="modal-content" *ngIf="permissionsUser">
    <div class="modal-header">
      <h3>User Permissions</h3>
      <span class="close" (click)="closePermissionsModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="user-info-section">
        <h4>User Information</h4>
        <p><strong>Name:</strong> {{ permissionsUser.name }}</p>
        <p><strong>Email:</strong> {{ permissionsUser.email }}</p>
        <p><strong>Role:</strong> {{ permissionsUserRole?.name || 'Unknown' }}</p>
        <p><strong>Department:</strong> {{ permissionsUser.department }}</p>
      </div>
      <div class="permissions-section">
        <h4>Role Permissions</h4>
        <div class="permissions-grid">
          <div class="permission-item" *ngFor="let perm of getPermissionsForUser()">
            <span class="permission-name">{{ perm.name }}</span>
            <span class="permission-desc">{{ perm.description }}</span>
          </div>
          <p *ngIf="getPermissionsForUser().length === 0">No permissions assigned</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closePermissionsModal()">Close</button>
    </div>
  </div>
</div>
