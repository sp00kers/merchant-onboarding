<app-navbar></app-navbar>

<div class="container">
  <div class="breadcrumb">
    <a routerLink="/account-management">Account Management</a>
    <span class="breadcrumb-separator">&gt;</span>
    <span class="breadcrumb-current">User Management</span>
  </div>

  <div class="page-header">
    <h1>User Management</h1>
    <button class="btn-primary" (click)="showCreateUserModal()">Add New</button>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-filters">
    <div class="search-bar">
      <input type="text" [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Search by name, email, or department...">
    </div>
    <div class="filter-controls">
      <select [(ngModel)]="roleFilter" (ngModelChange)="applyFilters()">
        <option value="">All Roles</option>
        <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
      </select>
      <select [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
        <option value="">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
      </select>
      <select [(ngModel)]="departmentFilter" (ngModelChange)="applyFilters()">
        <option value="">All Departments</option>
        <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
      </select>
    </div>
  </div>

  <div class="users-table">
    <table>
      <thead>
        <tr>
          <th>User ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Department</th>
          <th>Status</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers">
          <td>{{ user.id }}</td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ getRoleName(user.roleId) }}</td>
          <td>{{ user.department }}</td>
          <td><span [class]="'status-' + user.status">{{ user.status | titlecase }}</span></td>
          <td>{{ user.lastLogin }}</td>
          <td>
            <button class="btn-small" (click)="openViewUser(user.id)">View</button>
            <button class="btn-small" (click)="editUser(user.id)">Edit</button>
            <button class="btn-small btn-danger" (click)="deleteUser(user.id)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="filteredUsers.length === 0">
          <td colspan="8" style="text-align: center; padding: 20px;">No users found</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Create/Edit User Modal -->
<div class="modal" *ngIf="showUserModal" (click)="onBackdropClick($event)">
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ modalTitle }}</h3>
      <span class="close" (click)="closeUserModal()">&times;</span>
    </div>

    <!-- Modal Tabs (only for edit + admin) -->
    <div class="modal-tabs" *ngIf="currentEditingId && isAdmin" style="display: flex;">
      <button class="tab-btn" [class.active]="activeTab === 'details'" (click)="activeTab = 'details'">User Details</button>
      <button class="tab-btn" [class.active]="activeTab === 'permissions'" (click)="activeTab = 'permissions'">Permissions</button>
    </div>

    <div class="modal-body">
      <!-- User Details Tab -->
      <div *ngIf="activeTab === 'details'">
        <form>
          <div class="form-row">
            <div class="form-group">
              <label>Full Name:</label>
              <input type="text" [(ngModel)]="userName" name="userName" required>
            </div>
            <div class="form-group">
              <label>Email:</label>
              <input type="email" [(ngModel)]="userEmail" name="userEmail" required
                     placeholder="username&#64;bank.com"
                     pattern="^[a-zA-Z0-9._%+-]+@bank\.com$"
                     title="Email must use &#64;bank.com domain"
                     (ngModelChange)="validateEmail()"
                     [class.input-error]="emailError">
              <small class="hint" *ngIf="!emailError">Only &#64;bank.com email addresses are allowed</small>
              <small class="error-text" *ngIf="emailError">{{ emailError }}</small>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Role:</label>
              <select [(ngModel)]="userRole" name="userRole" required>
                <option value="">Select Role</option>
                <option *ngFor="let role of roles" [value]="role.id">{{ role.name }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Department:</label>
              <select [(ngModel)]="userDepartment" name="userDepartment" required>
                <option value="">Select Department</option>
                <option *ngFor="let dept of departments" [value]="dept">{{ dept }}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone Number:</label>
              <input type="tel" [(ngModel)]="userPhone" name="userPhone">
            </div>
            <div class="form-group">
              <label>Status:</label>
              <select [(ngModel)]="userStatus" name="userStatus" required>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Notes (Optional):</label>
            <textarea [(ngModel)]="userNotes" name="userNotes" rows="3" placeholder="Additional notes about the user..."></textarea>
          </div>
        </form>
      </div>

      <!-- Permissions Tab -->
      <div *ngIf="activeTab === 'permissions'">
        <div class="permissions-assignment">
          <h4>Assign Custom Permissions</h4>
          <p class="permission-note">Note: These permissions will override the default role permissions.</p>
          <div class="permissions-search">
            <input type="text" [(ngModel)]="permissionSearch" placeholder="Search permissions...">
          </div>
          <div class="permissions-container">
            <label class="permission-checkbox" *ngFor="let perm of getFilteredPermissions()">
              <input type="checkbox" [(ngModel)]="customPermissions[perm.id]">
              <div class="permission-info">
                <span class="permission-name">{{ perm.name }}</span>
                <span class="permission-desc">{{ perm.description }}</span>
              </div>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeUserModal()">Cancel</button>
      <button type="button" class="btn-primary" (click)="saveUser()">Save User</button>
    </div>
  </div>
</div>

<!-- View User Modal -->
<div class="modal" *ngIf="showViewModal" (click)="onBackdropClick($event)">
  <div class="modal-content" *ngIf="viewUser">
    <div class="modal-header">
      <h3>User Details</h3>
      <span class="close" (click)="closeViewModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="user-view-section">
        <h4>Personal Information</h4>
        <div class="info-grid">
          <div class="info-item"><label>User ID:</label><span>{{ viewUser.id }}</span></div>
          <div class="info-item"><label>Full Name:</label><span>{{ viewUser.name }}</span></div>
          <div class="info-item"><label>Email:</label><span>{{ viewUser.email }}</span></div>
          <div class="info-item"><label>Phone:</label><span>{{ viewUser.phone || 'Not provided' }}</span></div>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Role &amp; Department</h4>
        <div class="info-grid">
          <div class="info-item"><label>Role:</label><span>{{ viewUserRole?.name || 'Unknown' }}</span></div>
          <div class="info-item"><label>Department:</label><span>{{ viewUser.department }}</span></div>
          <div class="info-item"><label>Status:</label><span [class]="'status-' + viewUser.status">{{ viewUser.status | titlecase }}</span></div>
          <div class="info-item"><label>Last Login:</label><span>{{ viewUser.lastLogin }}</span></div>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Role Permissions</h4>
        <div class="permissions-display">
          <div class="permission-item-view" *ngFor="let perm of getViewUserPermissions()">
            <span class="permission-name">{{ perm.name }}</span>
            <span class="permission-desc">{{ perm.description }}</span>
          </div>
          <p *ngIf="getViewUserPermissions().length === 0">No permissions assigned</p>
        </div>
      </div>
      <div class="user-view-section">
        <h4>Additional Information</h4>
        <div class="info-item"><label>Notes:</label><p>{{ viewUser.notes || 'No notes available' }}</p></div>
        <div class="info-grid">
          <div class="info-item"><label>Created:</label><span>{{ viewUser.createdAt }}</span></div>
          <div class="info-item"><label>Last Updated:</label><span>{{ viewUser.updatedAt || 'Never' }}</span></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeViewModal()">Close</button>
    </div>
  </div>
</div>

<!-- User Permissions Modal -->
<div class="modal" *ngIf="showPermissionsModal" (click)="onBackdropClick($event)">
  <div class="modal-content" *ngIf="permissionsUser">
    <div class="modal-header">
      <h3>User Permissions</h3>
      <span class="close" (click)="closePermissionsModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="user-info-section">
        <h4>User Information</h4>
        <p><strong>Name:</strong> {{ permissionsUser.name }}</p>
        <p><strong>Email:</strong> {{ permissionsUser.email }}</p>
        <p><strong>Role:</strong> {{ permissionsUserRole?.name || 'Unknown' }}</p>
        <p><strong>Department:</strong> {{ permissionsUser.department }}</p>
      </div>
      <div class="permissions-section">
        <h4>Role Permissions</h4>
        <div class="permissions-grid">
          <div class="permission-item" *ngFor="let perm of getPermissionsForUser()">
            <span class="permission-name">{{ perm.name }}</span>
            <span class="permission-desc">{{ perm.description }}</span>
          </div>
          <p *ngIf="getPermissionsForUser().length === 0">No permissions assigned</p>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closePermissionsModal()">Close</button>
    </div>
  </div>
</div>
