<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Types Management - Merchant Onboarding Platform</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">Merchant Onboarding Platform</div>
        <div class="nav-menu">
            <a href="cases.html">Merchant Onboarding Cases</a>
            <a href="business-params.html">Business Parameters Management</a>
            <a href="account-management.html">Account Management</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
        <div class="user-info" id="userInfo"></div>
    </nav>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="business-params.html">Business Parameters</a>
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">Business Types</span>
        </div>
        
        <div class="page-header">
            <h1>Business Types Management</h1>
            <button class="btn-primary" onclick="showCreateBusinessTypeModal()">Add New</button>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-filters">
            <div class="search-bar">
                <input type="text" id="businessTypeSearch" placeholder="Search by code, name, or description..." onkeyup="filterBusinessTypes()">
            </div>
            <div class="filter-controls">
                <select id="statusFilter" onchange="filterBusinessTypes()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>
        
        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="businessTypesTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create/Edit Business Type Modal -->
    <div id="businessTypeModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="businessTypeModalTitle">Add Business Type</h3>
                <span class="close" onclick="closeBusinessTypeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="businessTypeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="businessTypeCode">Code *</label>
                            <input type="text" id="businessTypeCode" name="code" required maxlength="10" style="text-transform: uppercase;" placeholder="e.g., SP, PT, SB">
                        </div>
                        <div class="form-group">
                            <label for="businessTypeStatus">Status:</label>
                            <select id="businessTypeStatus" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="businessTypeName">Name *</label>
                        <input type="text" id="businessTypeName" name="name" required placeholder="e.g., Sole Proprietorship">
                    </div>
                    <div class="form-group">
                        <label for="businessTypeDescription">Description</label>
                        <textarea id="businessTypeDescription" name="description" rows="3" placeholder="Describe this business type..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeBusinessTypeModal()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="saveBusinessType()" class="btn-primary">Save Business Type</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let currentEditingId = null;
        let allBusinessTypes = [];

        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            displayUserRole();
            loadBusinessTypes();
        });

        function displayUserRole() {
            const roleId = localStorage.getItem('userRole');
            const role = roleManager.getRoleById(roleId);
            const roleName = role ? role.name : 'Unknown Role';
            document.getElementById('userInfo').textContent = `Role: ${roleName}`;
        }

        function loadBusinessTypes() {
            const defaultBusinessTypes = [
                {
                    id: 'bt1',
                    code: 'SP',
                    name: 'Sole Proprietorship',
                    description: 'Individual business ownership',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'bt2',
                    code: 'PT',
                    name: 'Partnership',
                    description: 'Business partnership between two or more individuals',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'bt3',
                    code: 'SB',
                    name: 'Sdn Bhd',
                    description: 'Private limited company',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'bt4',
                    code: 'BHD',
                    name: 'Bhd',
                    description: 'Public limited company',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                }
            ];

            const stored = localStorage.getItem('businessTypes');
            if (stored) {
                allBusinessTypes = JSON.parse(stored);
            } else {
                allBusinessTypes = defaultBusinessTypes;
                localStorage.setItem('businessTypes', JSON.stringify(allBusinessTypes));
            }

            displayBusinessTypes(allBusinessTypes);
        }

        function displayBusinessTypes(types) {
            const tbody = document.getElementById('businessTypesTableBody');
            tbody.innerHTML = '';

            types.forEach(type => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${type.code}</td>
                    <td>${type.name}</td>
                    <td>${type.description || '-'}</td>
                    <td><span class="status-${type.status}">${type.status.charAt(0).toUpperCase() + type.status.slice(1)}</span></td>
                    <td>${formatDate(type.createdAt)}</td>
                    <td>
                        <button class="btn-small" onclick="editBusinessType('${type.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteBusinessType('${type.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterBusinessTypes() {
            const searchTerm = document.getElementById('businessTypeSearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filteredTypes = allBusinessTypes.filter(type => {
                const matchesSearch = type.code.toLowerCase().includes(searchTerm) || 
                                    type.name.toLowerCase().includes(searchTerm) ||
                                    (type.description && type.description.toLowerCase().includes(searchTerm));
                const matchesStatus = !statusFilter || type.status === statusFilter;

                return matchesSearch && matchesStatus;
            });

            displayBusinessTypes(filteredTypes);
        }

        function showCreateBusinessTypeModal() {
            currentEditingId = null;
            document.getElementById('businessTypeModalTitle').textContent = 'Add Business Type';
            document.getElementById('businessTypeForm').reset();
            document.getElementById('businessTypeCode').disabled = false;
            document.getElementById('businessTypeModal').style.display = 'block';
        }

        function editBusinessType(id) {
            const type = allBusinessTypes.find(t => t.id === id);
            if (type) {
                currentEditingId = id;
                document.getElementById('businessTypeModalTitle').textContent = 'Edit Business Type';
                document.getElementById('businessTypeCode').value = type.code;
                document.getElementById('businessTypeCode').disabled = true;
                document.getElementById('businessTypeName').value = type.name;
                document.getElementById('businessTypeDescription').value = type.description || '';
                document.getElementById('businessTypeStatus').value = type.status;
                document.getElementById('businessTypeModal').style.display = 'block';
            }
        }

        function saveBusinessType() {
            const code = document.getElementById('businessTypeCode').value.trim().toUpperCase();
            const name = document.getElementById('businessTypeName').value.trim();
            const description = document.getElementById('businessTypeDescription').value.trim();
            const status = document.getElementById('businessTypeStatus').value;

            if (!code || !name) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (currentEditingId) {
                // Update existing
                const index = allBusinessTypes.findIndex(t => t.id === currentEditingId);
                if (index !== -1) {
                    allBusinessTypes[index] = {
                        ...allBusinessTypes[index],
                        code,
                        name,
                        description,
                        status,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Business type updated successfully!', 'success');
                }
            } else {
                // Create new
                if (allBusinessTypes.find(t => t.code === code)) {
                    showNotification('Business type code already exists', 'error');
                    return;
                }

                const newType = {
                    id: 'bt_' + Date.now(),
                    code,
                    name,
                    description,
                    status,
                    createdAt: new Date().toISOString()
                };
                allBusinessTypes.push(newType);
                showNotification('Business type created successfully!', 'success');
            }

            localStorage.setItem('businessTypes', JSON.stringify(allBusinessTypes));
            closeBusinessTypeModal();
            displayBusinessTypes(allBusinessTypes);
        }

        function deleteBusinessType(id) {
            const type = allBusinessTypes.find(t => t.id === id);
            if (!type) return;

            if (confirm(`Are you sure you want to delete business type "${type.name}"? This action cannot be undone.`)) {
                allBusinessTypes = allBusinessTypes.filter(t => t.id !== id);
                localStorage.setItem('businessTypes', JSON.stringify(allBusinessTypes));
                showNotification('Business type deleted successfully!', 'success');
                displayBusinessTypes(allBusinessTypes);
            }
        }

        function closeBusinessTypeModal() {
            document.getElementById('businessTypeModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('businessTypeModal');
            if (event.target === modal) {
                closeBusinessTypeModal();
            }
        }
    </script>
</body>
</html>