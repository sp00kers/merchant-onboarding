<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Merchant Categories Management - Merchant Onboarding Platform</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">Merchant Onboarding Platform</div>
        <div class="nav-menu">
            <a href="cases.html">Merchant Onboarding Cases</a>
            <a href="business-params.html">Business Parameters Management</a>
            <a href="account-management.html">Account Management</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
        <div class="user-info" id="userInfo"></div>
    </nav>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="business-params.html">Business Parameters</a>
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">Merchant Categories</span>
        </div>
        
        <div class="page-header">
            <h1>Merchant Categories Management</h1>
            <button class="btn-primary" onclick="showCreateMerchantCategoryModal()">Add New</button>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-filters">
            <div class="search-bar">
                <input type="text" id="merchantCategorySearch" placeholder="Search by code, name, or description..." onkeyup="filterMerchantCategories()">
            </div>
            <div class="filter-controls">
                <select id="statusFilter" onchange="filterMerchantCategories()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
                <select id="riskFilter" onchange="filterMerchantCategories()">
                    <option value="">All Risk Levels</option>
                    <option value="low">Low Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="high">High Risk</option>
                </select>
            </div>
        </div>
        
        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Risk Level</th>
                        <th>Status</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="merchantCategoriesTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create/Edit Merchant Category Modal -->
    <div id="merchantCategoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="merchantCategoryModalTitle">Add Merchant Category</h3>
                <span class="close" onclick="closeMerchantCategoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="merchantCategoryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="merchantCategoryCode">Code *</label>
                            <input type="text" id="merchantCategoryCode" name="code" required maxlength="10" style="text-transform: uppercase;" placeholder="e.g., RET, ECM, SRV">
                        </div>
                        <div class="form-group">
                            <label for="merchantCategoryStatus">Status:</label>
                            <select id="merchantCategoryStatus" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="merchantCategoryName">Name *</label>
                            <input type="text" id="merchantCategoryName" name="name" required placeholder="e.g., Retail, E-commerce">
                        </div>
                        <div class="form-group">
                            <label for="merchantCategoryRisk">Risk Level *</label>
                            <select id="merchantCategoryRisk" name="riskLevel" required>
                                <option value="">Select Risk Level</option>
                                <option value="low">Low Risk</option>
                                <option value="medium">Medium Risk</option>
                                <option value="high">High Risk</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="merchantCategoryDescription">Description</label>
                        <textarea id="merchantCategoryDescription" name="description" rows="3" placeholder="Describe this merchant category..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeMerchantCategoryModal()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="saveMerchantCategory()" class="btn-primary">Save Category</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let currentEditingId = null;
        let allMerchantCategories = [];

        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            displayUserRole();
            loadMerchantCategories();
        });

        function displayUserRole() {
            const roleId = localStorage.getItem('userRole');
            const role = roleManager.getRoleById(roleId);
            const roleName = role ? role.name : 'Unknown Role';
            document.getElementById('userInfo').textContent = `Role: ${roleName}`;
        }

        function loadMerchantCategories() {
            const defaultMerchantCategories = [
                {
                    id: 'mc1',
                    code: 'RET',
                    name: 'Retail',
                    description: 'Physical retail stores and outlets',
                    riskLevel: 'low',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'mc2',
                    code: 'ECM',
                    name: 'E-commerce',
                    description: 'Online retail and digital commerce',
                    riskLevel: 'medium',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'mc3',
                    code: 'F&B',
                    name: 'Food & Beverage',
                    description: 'Restaurants, cafes, and food services',
                    riskLevel: 'low',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'mc4',
                    code: 'SRV',
                    name: 'Services',
                    description: 'Professional and business services',
                    riskLevel: 'medium',
                    status: 'active',
                    createdAt: '2024-01-01T00:00:00.000Z'
                }
            ];

            const stored = localStorage.getItem('merchantCategories');
            if (stored) {
                allMerchantCategories = JSON.parse(stored);
            } else {
                allMerchantCategories = defaultMerchantCategories;
                localStorage.setItem('merchantCategories', JSON.stringify(allMerchantCategories));
            }

            displayMerchantCategories(allMerchantCategories);
        }

        function displayMerchantCategories(categories) {
            const tbody = document.getElementById('merchantCategoriesTableBody');
            tbody.innerHTML = '';

            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.code}</td>
                    <td>${category.name}</td>
                    <td>${category.description || '-'}</td>
                    <td><span class="risk-${category.riskLevel}">${category.riskLevel.charAt(0).toUpperCase() + category.riskLevel.slice(1)} Risk</span></td>
                    <td><span class="status-${category.status}">${category.status.charAt(0).toUpperCase() + category.status.slice(1)}</span></td>
                    <td>${formatDate(category.createdAt)}</td>
                    <td>
                        <button class="btn-small" onclick="editMerchantCategory('${category.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteMerchantCategory('${category.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterMerchantCategories() {
            const searchTerm = document.getElementById('merchantCategorySearch').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const riskFilter = document.getElementById('riskFilter').value;

            const filteredCategories = allMerchantCategories.filter(category => {
                const matchesSearch = category.code.toLowerCase().includes(searchTerm) || 
                                    category.name.toLowerCase().includes(searchTerm) ||
                                    (category.description && category.description.toLowerCase().includes(searchTerm));
                const matchesStatus = !statusFilter || category.status === statusFilter;
                const matchesRisk = !riskFilter || category.riskLevel === riskFilter;

                return matchesSearch && matchesStatus && matchesRisk;
            });

            displayMerchantCategories(filteredCategories);
        }

        function showCreateMerchantCategoryModal() {
            currentEditingId = null;
            document.getElementById('merchantCategoryModalTitle').textContent = 'Add Merchant Category';
            document.getElementById('merchantCategoryForm').reset();
            document.getElementById('merchantCategoryCode').disabled = false;
            document.getElementById('merchantCategoryModal').style.display = 'block';
        }

        function editMerchantCategory(id) {
            const category = allMerchantCategories.find(c => c.id === id);
            if (category) {
                currentEditingId = id;
                document.getElementById('merchantCategoryModalTitle').textContent = 'Edit Merchant Category';
                document.getElementById('merchantCategoryCode').value = category.code;
                document.getElementById('merchantCategoryCode').disabled = true;
                document.getElementById('merchantCategoryName').value = category.name;
                document.getElementById('merchantCategoryDescription').value = category.description || '';
                document.getElementById('merchantCategoryRisk').value = category.riskLevel;
                document.getElementById('merchantCategoryStatus').value = category.status;
                document.getElementById('merchantCategoryModal').style.display = 'block';
            }
        }

        function saveMerchantCategory() {
            const code = document.getElementById('merchantCategoryCode').value.trim().toUpperCase();
            const name = document.getElementById('merchantCategoryName').value.trim();
            const description = document.getElementById('merchantCategoryDescription').value.trim();
            const riskLevel = document.getElementById('merchantCategoryRisk').value;
            const status = document.getElementById('merchantCategoryStatus').value;

            if (!code || !name || !riskLevel) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (currentEditingId) {
                // Update existing
                const index = allMerchantCategories.findIndex(c => c.id === currentEditingId);
                if (index !== -1) {
                    allMerchantCategories[index] = {
                        ...allMerchantCategories[index],
                        code,
                        name,
                        description,
                        riskLevel,
                        status,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Merchant category updated successfully!', 'success');
                }
            } else {
                // Create new
                if (allMerchantCategories.find(c => c.code === code)) {
                    showNotification('Merchant category code already exists', 'error');
                    return;
                }

                const newCategory = {
                    id: 'mc_' + Date.now(),
                    code,
                    name,
                    description,
                    riskLevel,
                    status,
                    createdAt: new Date().toISOString()
                };
                allMerchantCategories.push(newCategory);
                showNotification('Merchant category created successfully!', 'success');
            }

            localStorage.setItem('merchantCategories', JSON.stringify(allMerchantCategories));
            closeMerchantCategoryModal();
            displayMerchantCategories(allMerchantCategories);
        }

        function deleteMerchantCategory(id) {
            const category = allMerchantCategories.find(c => c.id === id);
            if (!category) return;

            if (confirm(`Are you sure you want to delete merchant category "${category.name}"? This action cannot be undone.`)) {
                allMerchantCategories = allMerchantCategories.filter(c => c.id !== id);
                localStorage.setItem('merchantCategories', JSON.stringify(allMerchantCategories));
                showNotification('Merchant category deleted successfully!', 'success');
                displayMerchantCategories(allMerchantCategories);
            }
        }

        function closeMerchantCategoryModal() {
            document.getElementById('merchantCategoryModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('merchantCategoryModal');
            if (event.target === modal) {
                closeMerchantCategoryModal();
            }
        }
    </script>
</body>
</html>