<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Categories Management - Merchant Onboarding Platform</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand" onclick="window.location.href='dashboard.html'" style="cursor: pointer;">Merchant Onboarding Platform</div>
        <div class="nav-menu">
            <a href="cases.html">Merchant Onboarding Cases</a>
            <a href="business-params.html">Business Parameters Management</a>
            <a href="account-management.html">Account Management</a>
            <a href="#" onclick="logout()">Logout</a>
        </div>
        <div class="user-info" id="userInfo"></div>
    </nav>
    
    <div class="container">
        <div class="breadcrumb">
            <a href="business-params.html">Business Parameters</a>
            <span class="breadcrumb-separator">></span>
            <span class="breadcrumb-current">Risk Categories</span>
        </div>
        
        <div class="page-header">
            <h1>Risk Categories Management</h1>
            <button class="btn-primary" onclick="showCreateRiskCategoryModal()">Add New</button>
        </div>
        
        <!-- Search and Filter Section -->
        <div class="search-filters">
            <div class="search-bar">
                <input type="text" id="riskCategorySearch" placeholder="Search by level, name, or description..." onkeyup="filterRiskCategories()">
            </div>
        </div>
        
        <div class="users-table">
            <table>
                <thead>
                    <tr>
                        <th>Level</th>
                        <th>Name</th>
                        <th>Score Range</th>
                        <th>Description</th>
                        <th>Actions Required</th>
                        <th>Created Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="riskCategoriesTableBody">
                    <!-- Dynamic content will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create/Edit Risk Category Modal -->
    <div id="riskCategoryModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="riskCategoryModalTitle">Add Risk Category</h3>
                <span class="close" onclick="closeRiskCategoryModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="riskCategoryForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="riskCategoryLevel">Level *</label>
                            <input type="number" id="riskCategoryLevel" name="level" required min="1" max="10" placeholder="1-10">
                        </div>
                        <div class="form-group">
                            <label for="riskCategoryName">Name *</label>
                            <input type="text" id="riskCategoryName" name="name" required placeholder="e.g., Low Risk, High Risk">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="riskCategoryScore">Score Range *</label>
                        <input type="text" id="riskCategoryScore" name="scoreRange" required placeholder="e.g., 0-30, 70-100">
                    </div>
                    <div class="form-group">
                        <label for="riskCategoryDescription">Description</label>
                        <textarea id="riskCategoryDescription" name="description" rows="3" placeholder="Describe this risk category..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="riskCategoryActions">Actions Required</label>
                        <textarea id="riskCategoryActions" name="actionsRequired" rows="3" placeholder="Describe required actions for this risk level"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="closeRiskCategoryModal()" class="btn-secondary">Cancel</button>
                <button type="button" onclick="saveRiskCategory()" class="btn-primary">Save Risk Category</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let currentEditingId = null;
        let allRiskCategories = [];

        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            displayUserRole();
            loadRiskCategories();
        });

        function displayUserRole() {
            const roleId = localStorage.getItem('userRole');
            const role = roleManager.getRoleById(roleId);
            const roleName = role ? role.name : 'Unknown Role';
            document.getElementById('userInfo').textContent = `Role: ${roleName}`;
        }

        function loadRiskCategories() {
            const defaultRiskCategories = [
                {
                    id: 'rc1',
                    level: 1,
                    name: 'Low Risk',
                    scoreRange: '0-30',
                    description: 'Minimal risk requiring standard verification',
                    actionsRequired: 'Standard document verification and basic due diligence',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'rc2',
                    level: 2,
                    name: 'Medium Risk',
                    scoreRange: '31-70',
                    description: 'Moderate risk requiring enhanced verification',
                    actionsRequired: 'Enhanced due diligence, additional documentation, senior approval required',
                    createdAt: '2024-01-01T00:00:00.000Z'
                },
                {
                    id: 'rc3',
                    level: 3,
                    name: 'High Risk',
                    scoreRange: '71-100',
                    description: 'High risk requiring comprehensive assessment',
                    actionsRequired: 'Comprehensive due diligence, management approval, ongoing monitoring',
                    createdAt: '2024-01-01T00:00:00.000Z'
                }
            ];

            const stored = localStorage.getItem('riskCategories');
            if (stored) {
                allRiskCategories = JSON.parse(stored);
            } else {
                allRiskCategories = defaultRiskCategories;
                localStorage.setItem('riskCategories', JSON.stringify(allRiskCategories));
            }

            displayRiskCategories(allRiskCategories);
        }

        function displayRiskCategories(categories) {
            const tbody = document.getElementById('riskCategoriesTableBody');
            tbody.innerHTML = '';

            // Sort by level
            const sortedCategories = categories.sort((a, b) => a.level - b.level);

            sortedCategories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.level}</td>
                    <td>${category.name}</td>
                    <td>${category.scoreRange}</td>
                    <td>${category.description || '-'}</td>
                    <td>${category.actionsRequired || '-'}</td>
                    <td>${formatDate(category.createdAt)}</td>
                    <td>
                        <button class="btn-small" onclick="editRiskCategory('${category.id}')">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteRiskCategory('${category.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterRiskCategories() {
            const searchTerm = document.getElementById('riskCategorySearch').value.toLowerCase();

            const filteredCategories = allRiskCategories.filter(category => {
                const matchesSearch = category.level.toString().includes(searchTerm) ||
                                    category.name.toLowerCase().includes(searchTerm) ||
                                    category.scoreRange.toLowerCase().includes(searchTerm) ||
                                    (category.description && category.description.toLowerCase().includes(searchTerm));

                return matchesSearch;
            });

            displayRiskCategories(filteredCategories);
        }

        function showCreateRiskCategoryModal() {
            currentEditingId = null;
            document.getElementById('riskCategoryModalTitle').textContent = 'Add Risk Category';
            document.getElementById('riskCategoryForm').reset();
            document.getElementById('riskCategoryLevel').disabled = false;
            document.getElementById('riskCategoryModal').style.display = 'block';
        }

        function editRiskCategory(id) {
            const category = allRiskCategories.find(c => c.id === id);
            if (category) {
                currentEditingId = id;
                document.getElementById('riskCategoryModalTitle').textContent = 'Edit Risk Category';
                document.getElementById('riskCategoryLevel').value = category.level;
                document.getElementById('riskCategoryLevel').disabled = true;
                document.getElementById('riskCategoryName').value = category.name;
                document.getElementById('riskCategoryScore').value = category.scoreRange;
                document.getElementById('riskCategoryDescription').value = category.description || '';
                document.getElementById('riskCategoryActions').value = category.actionsRequired || '';
                document.getElementById('riskCategoryModal').style.display = 'block';
            }
        }

        function saveRiskCategory() {
            const level = parseInt(document.getElementById('riskCategoryLevel').value);
            const name = document.getElementById('riskCategoryName').value.trim();
            const scoreRange = document.getElementById('riskCategoryScore').value.trim();
            const description = document.getElementById('riskCategoryDescription').value.trim();
            const actionsRequired = document.getElementById('riskCategoryActions').value.trim();

            if (!level || !name || !scoreRange) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (currentEditingId) {
                // Update existing
                const index = allRiskCategories.findIndex(c => c.id === currentEditingId);
                if (index !== -1) {
                    allRiskCategories[index] = {
                        ...allRiskCategories[index],
                        level,
                        name,
                        scoreRange,
                        description,
                        actionsRequired,
                        updatedAt: new Date().toISOString()
                    };
                    showNotification('Risk category updated successfully!', 'success');
                }
            } else {
                // Create new
                if (allRiskCategories.find(c => c.level === level)) {
                    showNotification('Risk category level already exists', 'error');
                    return;
                }

                const newCategory = {
                    id: 'rc_' + Date.now(),
                    level,
                    name,
                    scoreRange,
                    description,
                    actionsRequired,
                    createdAt: new Date().toISOString()
                };
                allRiskCategories.push(newCategory);
                showNotification('Risk category created successfully!', 'success');
            }

            localStorage.setItem('riskCategories', JSON.stringify(allRiskCategories));
            closeRiskCategoryModal();
            displayRiskCategories(allRiskCategories);
        }

        function deleteRiskCategory(id) {
            const category = allRiskCategories.find(c => c.id === id);
            if (!category) return;

            if (confirm(`Are you sure you want to delete risk category "${category.name}"? This action cannot be undone.`)) {
                allRiskCategories = allRiskCategories.filter(c => c.id !== id);
                localStorage.setItem('riskCategories', JSON.stringify(allRiskCategories));
                showNotification('Risk category deleted successfully!', 'success');
                displayRiskCategories(allRiskCategories);
            }
        }

        function closeRiskCategoryModal() {
            document.getElementById('riskCategoryModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('riskCategoryModal');
            if (event.target === modal) {
                closeRiskCategoryModal();
            }
        }
    </script>
</body>
</html>